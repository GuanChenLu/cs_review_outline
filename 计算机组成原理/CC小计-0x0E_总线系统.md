# 总线系统

## 总线的概念

概念：

- 内部总线：CPU 内部连接各个寄存器和运算器之间的总线
- 系统总线：CPU 和计算机中高速设备之间的连接
- IO 总线：中低速 IO 设备之间

总线带宽是描述总线传输数据的单位，`MB/s`



连接：

单总线

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220518141542.png)

总线为分时的控制状态，效率较低



多总线

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220518141636.png)

各种速度的设备连接到不同的总线上，同时工作

效率和吞吐提升



内部结构：

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220518142019.png)

简单的总线结构中，CPU 是总线上唯一的控制者，总线是 CPU 引脚的延申，结构与 CPU 密切相关，通用性较差



![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220518142048.png)

现代的总线内部结构采用模块化设计，采用多层次的结构，便于扩展和维护

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220518142211.png)



## 总线接口

### 信息的传送方式

串行：

只有一根传输线，采用脉冲有序传输

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220518142621.png)

通信双方遵守同样的通信协议

起始位，数据位，校验位，结束位，空闲位



并行：

每个数据的传输需要单独的传输线，采用电位传输，但是在实际上传输效率可能不如串行传输(频率上不去)

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220518142939.png)



### 总线接口

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220518143023.png)

总线接口控制着 CPU 和主存，外设之间通过总线经行连接的逻辑部件

根据数据的传输方式，适配器范围串行数据接口和并行数据接口

接口的功能：

1. 控制
2. 缓冲
3. 状态
4. 转换
5. 整理
6. 程序中断



## 总线的仲裁

> 以某种方式选择一个主设备作为总线的下一次访问对象

### 集中式

某个想要获得总线使用权的模块都有两条线连接到中央仲裁器

1. BR 发出使用请求
2. BG 授权使用

有三种仲裁方式：

1. 链式 —— 发请求、链式查询

    ![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220518143823.png)

    - 优点：连接简单，判断方式简单，扩充容易
    - 缺点：询问链路故障敏感、优先级的影响较大

2. 计数器定时查询 —— 通过计数器确定开始询问的对象

    ![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220518144028.png)

    每次查询可以从 0 开始，也可以从上一次询问的位置开始，以增加线数来增加灵活性

3. 独立请求

    ![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220518144148.png)

    响应时间短、控制灵活，但是线束较多，“排队器”实现复杂



### 分布式

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220518144307.png)

不需要中央仲裁器，各个模块都有自己的仲裁号和仲裁器

以优先级仲裁策略为基础

总线上 **保留当前占用总线的模块的仲裁号**，其他模块在请求时会将之与自己的号作比较，如果小，撤销其仲裁号，不予响应



## 总线的定时

在总线上的数据传送过程，大致可以分为如下的几个阶段：

1. 请求总线
2. 总线仲裁
3. 寻址
4. 信息传送
5. 状态返回

定制机制控制着总线上各个阶段的时序关系，使之有条不紊地进行



### 同步定时

由统一的时钟规定，传输的效率较高

但是各模块的存取时间需要比较接近，总线的长度不能太长

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220518145615.png)

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220518145633.png)



### 异步定时

建立在应答式/互锁机制上

总线的周期长度可变，后一事件在总线上的时刻取决于前一事件的出现

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220518145918.png)

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220518150144.png)



### 半同步定时

在同步的基础上增加一根联通信号线，由这个信号决定是否需要增加时钟周期，具有较好的适应性



### 周期分裂式定时

将一个读周期分解为两个分离的传输子周期，有点像 [协程](https://zh.wikipedia.org/zh-cn/%E5%8D%8F%E7%A8%8B)

- 第一个子周期，主方发送地址和命令有关信息之后，立即与总线断开供其他设备使用
- 第二个子周期，被读的设备重新申请总线使用权后将数据通过总线发向请求数据的设备

要求读数据的双方都是总线的主方，以硬件的复杂程度提高总线性能的提升



## 总线的数据传送模式

- 读写模式
- 块传送
- 写后读，读修改写操作
- 广播、广集



## 多总线结构和 PCI、PCIE

对于传输速度不同的设备可以适配不同的总线

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220518151109.png)

- PCI 总线连接各种高速的设备，与处理器不直接相关

    采用同步时序协议和集中式仲裁策略，可以自动配置

    连接的设备可以是主设备也可以是从设备

    支持无限的猝发式传送

- `LAGACY 总线`可以是传统的性能较低的总线，比如说 `ISA EISA MCA`

可以看到，在 `PCI` 总线系统中有三个桥，其中 `HOST` 桥又是 `PCI` 总线控制器，含有中央仲裁器

桥，是一个总线转换部件，可以把一条总线的地址空间映射到另一条总线的地址空间上，从而使系统中任意一个总线设备都能看到同样一份地址表



### PCIE 总线

> PCI-Express

1. 兼容 PCI
2. 高频串行传输
3. 全双工 **端对端** 连接
4. 多通道数据



<br/>

<br/>

---

完

:joy:



