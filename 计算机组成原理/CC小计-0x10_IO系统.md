# I/O 系统

> CPU 通过 IO 接口间接和外设打交道
>
> 可以通过软硬件的方式控制输入输出

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220526155735.png)



## IO接口与端口

为便于 CPU 访问，IO 端口的编址有两种方式：

1. 统一编址 —— 将 IO 接口中的寄存器和内存单元联合在一起编址，不需要特殊的 IO 指令
2. 独立编址 —— 将内存的地址和 IO 地址分开，需要特殊的 IO 指令



## IO 操作的一般过程

1. IO 都是从 CPU 将地址数据放到地址总线上开始，选择一个输入设备
2. 等候输入设备的数据成为有效 / 将待输入的数据放在数据总线上
3. CPU 从数据总线上读入数据放到寄存器中 / 输出设备认为数据有效，将数据取走



根据外设的速度不同，可以有三种传输数据的方式：

1. 无条件传输 —— 针对的是速度较慢的外设
2. 应答方式，异步传输 —— 速度中等
3. 同步时钟，高速传输 —— 速度较快，采用同步时钟控制



CPU 负责实现和 IO 设备打交道，在操作系统设计的时候，可以通过软硬件的方式实现 IO 的控制

1. 无条件传送
2. 程序查询的方式
3. 程序中断的方式
4. DMA 
5. 通道 IO 处理 (IOP)



## ![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220526160747.png)



## 程序控制 IO 

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220601191805.png)

数据在 CPU 和外设之间的传送全靠程序(操作系统)控制，当需要 IO 的时候，CPU 暂停，转去服务程序中的 IO 指令进行数据传送

IO 接口作为 CPU 和外设之间的部件，向上提供接口，向下兼容

IO 指令一般需要三种功能：

1. 能够选中某些设备的接口
2. 测试设备的状态
3. 传送数据

一般传输数据的流程是这样：

1. 发出命令，请求数据传输，改变接口的状态字
2. 从 IO 接口读入状态字
3. 检查状态字验证数据交换的可行性直到可行
4. 从总线上把数据读入 CPU 中的寄存器中，或者是将 CPU 中的数据输出到接口中的缓冲寄存器内，恢复接口的状态字



优点：

1. CPU 操作可以和 IO 接口操作同步，接口的硬件比较简单

缺点：

1. 当程序进入循环的时候，CPU 只能等待而做不了其他的事情

改进：

​	在执行主要程序的时候，可以周期性地调用 IO 设备询问子程序，测试接口



## 中断

CPU 在执行程序的过程中，被内部或者是外部的事情打断，转而去执行一段预先被安排好的程序，服务结束之后，又返回到原来的断点，继续执行

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220601193116.png)

中断的处理流程：

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220601193415.png)

- 每当一条指令执行结束，CPU 便检查中断请求信号，确定是不是要进入中断周期

- 如同函数的调用一样，被调用的函数需要知道自己在哪个地方被调用，主程序在执行中断服务之前也需要把程序计数器中的值以及当前指令结束之后 CPU 的状态字保存到堆栈中



### 中断服务程序的入口地址的获取

#### 向量中断

由硬件在中断周期中完成查找中断源、中断排队与判优、获取中断服务程序的入口地址



#### 查询中断

由软件查询中断源，获取中断服务的入口地址

和内存分页管理的形式差不多，所有的中断服务程序的入口地址会被汇总在一张大表中，我们将这张表称为 `中断向量表`，里面存储的中断程序的入口地址称为 `中断向量`，将这张表的地址称为 `向量地址`

<img src="https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220601194350.png" style="zoom:50%;" />

允许中断的标识是 CPU 中的中断请求标志`IR`(表示是否发出中断)和中断屏蔽标志`IM`(表示是否受理中断) 

还有接口中的 `RD`(表示准备就绪触发器)和 `EI`（允许中断触发器）



![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220601194819.png)



### 单级中断

单极中断常采用串行排队列法来实现判断优先级

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220601195625.png)

响应

当 CPU 识别出中断源的时候，由硬件直接产生与之对应的向量地址，指向每个中断源的中断服务程序入口，转入某个中断程序，因此在设计电路的时候就要考虑所有的中断源的向量地址

也可以通过 `CPU某一寄存器的值 + 偏移量`找到入口地址



### 多级中断

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220601202020.png)

可以设计多级中断，在每一级终端中也可以设置不同的优先级

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220601202142.png)

多级之间的中断可以实现中断嵌套，但是同一级中的中断是不能嵌套的，必须是处理完一个中断之后在响应处理同一级中的其他中断源



对于多级中断，使用栈保存现场的好处如下：

1. 按照FILO的顺序控制比较简单
2. 各级中断现场可以按照其顺序放在一个栈中，不用单独设置现场保护区

在多级中断中，每一级均有一根中断请求线送往 CPU 的中断优先级排队电路，每一级因此被赋予了不同的优先级



上个题目

```shell
参见上图所示的二维中断系统。请问
(1)在中断情况下，CPU和设备的优先级如何考虑? 请按降序排列各设备的中断优先级。
(2)若CPU现执行设备B的中断服务程序，IM2，IM1，IM0的状态是什么? 如果CPU执行设备D的中断服务程序，IM2，IM1，IM0的状态又是什么? 
(3)每一级的IM能否对某个优先级的个别设备单独进行屏蔽? 如果不能，采取什么办法可达到目的?
(4)假如设备C一提出中断请求，CPU立即进行响应，如何调整才能满足此要求?

```

```shell
(1)在中断情况下，CPU的优先级最低。各设备的优先次序是：
A→B→C→D→E→F→G→H→I→CPU
(2)执行设备B的中断服务程序时，IM2IM1IM0=111；执行设备D的中断服务程序时，IM2IM1IM0=011
(3)每一级的IM标志不能对某个优先级的个别设备进行单独屏蔽。可将接口中的EI(中断允许)标志清“0”，它禁止设备发出中断请求。 
(4)要使设备C的中断请求及时得到响应，可将设备C从第2级取出来，单独放在第3级上，使第3级的优先级最高，即令IM3=0即可。
```



```shell
参见图8.12(b)所示的系统，只考虑A，B，C三个设备组成的单级中断结构，它要求CPU在执行完当前指令时对中断请求进行服务。假设：
(1)CPU“中断批准”机构在响应一个新的中断之前，先要让被中断的程序的一条指令一定要执行完毕；
(2)TDC为查询链中每个设备的延迟时间；
(3)TA、TB、TC分别为设备A、B、C的服务程序所需的执行时间； 
(4)TS、TR为保存现场和恢复现场所需的时间；
(5)主存工作周期为TM。 试问：就这个中断请求环境来说，系统在什么情况下达到中断饱和?

解：
假设执行一条指令的时间也为TM
如果三个设备同时发出中断请求，那么依次分别处理设备A、设备B、设备C的时间如下： 
tA = 2TM + TDC + TS + TA + TR
tB = 2TM + 2TDC + TS + TB + TR
tC = 2TM + 3TDC + TS + TC + TR
处理三个设备所需的总时间为：T=tA+tB+tC
T是达到中断饱和的最小时间，即中断极限频率为：f=1/T

```





## DMA

是一种完全由硬件执行的 IO 交换的方式

数据交换不经过 CPU，而是直接在内存和 IO 接口之间进行，数据的传输效率更高

DMA 控制器向内存发出地址和控制信号，修改地址，对传送的字的个数计数，并且 之后以中断的方式向 CPU 报告操作的结束

以上所有的操作都是由硬件电路直接实现的，同时也减少了 CPU 的负担

适合于主存和 高速 IO 设备之间的简单的数据传输



具体操作流程：

1. 向 CPU 发出 DMA 请求
2. CPU 接收请求，将 CPU 工作改为 DMA 操作方式，DMA 控制器接管总线的控制
3. 由 DMA 传送数据到内存中的指定位置，计数
4. DMA 控制器向 CPU 报告操作结束



可以看出，DMA 控制器需要和 CPU 分时占用内存，通常对于两者占用 内存 有三种调度策略

1. 成组连续传送(CPU 完全停止访问)

    <img src="https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220601205857.png" style="zoom:50%;" />

    缺点在于内存的能效没有充分的发挥，在数据传送的时间中内存是空闲的

2. 周期挪用(单字节传输，周期窃取)

    当 IO 设备有 DMA 请求，由 IO 设备挪用一个或几个内存周期

    除此之外，对总线申请、取得控制、归还还需要时间

    适用于较慢的 IO 设备

    - CPU 不需要访存，没有冲突
    - CPU 需要访存，IO 设备优先，CPU 延缓对指令的执行，在 CPU 访问内存的指令中加入 DMA 请求，挪用一、二个内存周期

    <img src="https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220601210946.png" style="zoom:50%;" />

3. 透明访问(DMA 和 CPU 交替访问内存)

    如果 CPU 工作时间比内存存取的时间长很多，那么采用这种方式能够使 DMA传送和 CPU 同时发挥最高的效率

    <img src="https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220601211710.png" style="zoom:50%;" />

    通过分时进行不需要总线使用权的申请、建立、归还，因此总线控制权的转移不需要很多时间，DMA 的传输效率高，且 CPU 无感

    但是，硬件逻辑比较复杂

    

    

### DMA 传输的细节

​    <img src="https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220601212103.png" style="zoom:67%;" />



![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220601212533.png)



由两种结构的 DMA

1. 选择性 DMA

    在物理上可以连接多个设备，在逻辑上只允许连接一个设备，把一个 DMA 分时为多个设备服务

    ![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220601212738.png)

2. 多路型

    同时为多个外设服务，多设备通过 `字节交叉`的方式通过 `DMA` 进行数据传输

    <img src="https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220601212855.png" style="zoom:50%;" />



DMA 和中断的关系

- 中断是程序的切换，需要保护和恢复现场，DMA 除了预处理和后处理，其他时间不占用 CPU 的资源
- 因为不需要 CPU 干预，DMA 效率比较高，适合于高速外设成组传输
- DMA 优先级比中断高
- 中断有对异常的处理能力，而 DMA 仅限于传输数据的 IO 操作
- 从传输方式上来看，DMA 靠硬件，中断靠软件



## 通道

通道加载 IO 总线和 CPU/内存 之间，有自己的指令和程序负责数据的输入输出，这样 CPU 只需要关注 `数据处理` 功能，进一步提高其效率

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220601214623.png)

这样，整个 IO 结构就变成了这样

```shell
CPU与内存 -存储总线->   通道     设备控制器（I/O模块）    外围设备
```

具有不同的通道能够对不同类型的 IO 设备作不同的管理



在整个结构中，最关键的存储管理部件主要用来根据实现确定的优先顺序，决定下一周期由哪个部件使用存储在线访问内存

- 对于多数 IO 设备读写信号具有实时性，需要及时处理，所以通道的优先级大于 CPU
- 对于各个通道而言，选择通道的优先级高于多路通道



通道的基本功能：

1. 按照 CPU 的 IO 指令对外设通信
2. 从内存中选取该通道的指令，译码后向 IO　控制器模块发送各种命令
3. 组织外设和内存进行数据传输，提供数据缓冲的空间，提供数据存入内存的地址和传输的数据量
4. 从外设得到状态信息，形成并且保存通道的状态信息，将状态信息送到内存中的指定地址供　cpu　使用
5. 将外设中断和通道不是的中断，按次序及时报告给　ＣＰＵ



### CPU对通道的管理

CPU通过执行I/O指令以及处理来自通道的中断，实现对通道的管理

来自通道的中断有两种：数据传送结束中断和故障中断 

大中型计算机的I/O指令都是内核指令，用户态时不能运行I/O指令





###      通道对设备控制器的管理   

通道通过使用 通道指令 控制I/O模块进行数据传送操作，并以 通道状态字 接收 I/O 模块反映的外围设备的状态

I/O模块是通道对I/O设备实现传输控制的执行机构



####      I/O模块的具体任务  

1. 从通道接受通道指令，控制外围设备完成所要求的操作

2. 向通道反映外围设备的状态

3. 将各种外围设备的不同信号转换成通道能够识别的标准信号



### 通道的类型

选择通道

用于连接高速设备，在物理上可以连接多个设备，但是在某一时刻只能有一个在工作，辅助时间很长

专门性很强



多路通道

同一时间能处理多个I/O设备的数据传输  

- 数组多路通道

    设备执行数据传送时通道只为它服务，在设备执行 `控制性` 动作的时候挂起转去执行其它设备的通道程序

    在一段时间内能交替执行多个设备的通道程序，在逻辑上可以连接多个设备，这些设备应该是高速设备   

    有点像协程的理念

- 字节多路通道

    连接低速设备，在传送两个字节之间的空闲时间服务其他设备



异同

同：

- 都是多路通道，在一段时间内能交替执行多个设备的通道程序，使这些设备几乎同时工作

异：

- 数组多路通道允许多个设备同时工作，但 只允许一个设备进行 传输型操作，其他设备进行 控制型操作

- 字节多路通道不仅允许多个设备同时操作，而且也允许它们同时进行传输型操作，通过传输的间隙切换服务

- 数组多路通道与设备之间数据传送的基本单位是 `数据块`，通道必须为一个设备传送完一个数据块后，才能为别的设备传送数据块

- 字节多路通道与设备之间数据传送的基本单位是`字节`，各设备与通道之间的数据传送是以字节为单位交替进行



### 通道结构的发展

1. 输入输出处理器(IOP)

    通道结构的I/O处理器

    IOP可以和CPU并行工作，提供高速的DMA处理能力，实现数据的高速传送，它是主机的一个部件

    IOP可应用于中小型及微型计算机中。
    
    

2. 外围处理机(PPU, peripheral processing unit) 

    PPU 基本上独立于主机工作的，有自己的指令系统，完成算术/逻辑运算，读/写主存储器，与外设交换信息等

    外围处理机I/O方式一般应用于大型高效率的计算机系统中





<br/>

<br/>

<br/> 

---

计算机组成原理完结散花 :rose:

