# 中央处理器

> 了解一下

## CPU 的功能和组成

CPU 需要完成下面的几种功能

1. 操作控制：程序的顺序控制
2. 指令控制：产生各种指令信号(微操作信号)
3. 时间控制，控制操作信号的有效时间
4. 数据加工，对数据决心逻辑运算和算数运算(ALU)



![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220510143446.png)



CPU 主要由：

1. 控制器
2. 运算器
3.  `cache`
4. 芯片级总线

组成



### 控制器

- 从 cache 中取出一条指令，并且指出下一条指令的位置
- 对指令进行译码或测试，产生操作控制信号，完成预定的操作
- 指挥控制 `CPU` 、数据 cache 和 `IO` 设备之间的数据的流动的方向



### CPU 中主要的寄存器

数据缓冲寄存器：

1. 作为 `ALU` 运算结果和通用寄存器之间的缓冲
2. 暂存 `ALU` 的运算结果，或者是来自内存或者是 `IO` 接口的数据
3. 补偿 `CPU` 和内存、外围设备之间的速度上的差异



指令寄存器(IR)和指令译码器(ID)：

前者用来保存当前正在执行的一条指令，后者接收 `IR` 中传入的操作码字段，经过译码之后向操作控制器发出具体的操作信号



程序计数器：

1. 存放下一条指令的地址
2. 顺序执行 `PC` 自增，遇到转移指令由转移指令来规定
3. 可以寄存信息和计数



数据地址寄存器：

1. 保存 `CPU` 访存地址
2. 采用 电位-脉冲 方式，电位输入端对应数据信息位，脉冲输入端对应控制信号，在控制信号的作用下，将信息打入寄存器中



通用寄存器



程序状态字寄存器：

保存条件代码和中断及系统工作状态等信息



操作控制器：

根据指令操作码和时序信号，产生操作控制信号，以便正确建立 `数据通路`，在寄存器之间正确建立数据通路

操作控制器可分为两种

1. 时序逻辑型 ——> 采用 硬布线控制器
2. 存储逻辑型 ——> 采用 微程序控制器



时序产生器：

发出计算机需要的时序控制信号，对各种操作信号实施时序上的控制



## 指令周期

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220510150258.png)

1 指令周期 = 若干个 CPU 周期

1 CPU 周期 = 若干个时钟周期

指令周期：`CPU` 读取一条指令 + 执行完这条指令 的时间之和

CPU 周期：又称机器周期，从内存读取一个指令字的最短时间

时钟周期：又称 T 周期或者是 节拍脉冲，是处理操作的最基本的单位



![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220510150135.png)

上述的图片演示的是采用定长 CPU 周期的指令周期



接下来通过 CPU 模型来分析几种指令的执行流程

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220510150442.png)

### MOV

是 `RR` 型指令，需要两个 `CPU` 周期

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220510150625.png)



#### 取地址周期

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220510150840.png)

1. PC 中装入第一条指令的地址
2. 根据 PC 地址读取到的指令被放到 `ABUS` 上，对指令寄存器进行译码(找到在指令寄存器中合适的位置)，并且启动读命令
3. 指令被装入 IR
4. PC + 1
5. 操作码 `MOV` 被译码，被 CPU 识别



#### 执行周期

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220510151354.png)

1. 操作控制器送出控制信号到通用寄存器，选择 `R0 / R1` 作为 `源寄存器 / 目标寄存器`
2. `OC` 送控制信号到 `ALU` 指定其做传输操作
3. `OC` 送控制信号，打开 ALU 输出，将数据送到 DBUS 上
4. `OC` 送控制信号，将 DBUS 上的数据打入数据缓冲器中
5. `OC` 送控制信号，将数据缓冲器 DR 中的数据打入 R1 中



### LAD

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220510153010.png)

取地址阶段需要送操作数的地址到地址寄存器然后从内存中取出该位置上的操作数装入通用寄存器

![1652167935065](C:%5CUsers%5Cgcl%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1652167935065.png)

步骤前面妹写就是 `OC` 发出控制信号

1. 打开 IR输出三态门，将指令中的直接地址码 `6` 放在 DBUS
2. 将地址码 6 装入 `AR`
3. OC 发出读命令，将数存 6 单元中的数 100 读出到 DBUS 上
4. 将 100 读入 DR
5. 将 DR 中的 100 装入 R1，原来的值被冲掉



### ADD

![1652168231914](C:%5CUsers%5Cgcl%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1652168231914.png)

1. 选定源/目标寄存器
2. 输出 加法命令 到 ALU
3. 打开 ALU 输出三态门，将结果 120 放到 DBUS 上
4. 打入 DR
5. 打入 R2

### STO

取地址、送地址译码、写入

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220510154102.png)

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220510153945.png)

1. 选取 `R3` 的中内容作为存贮器存储器的地址
2. 将 30 放到 `DBUS` 上
3. 将 30 打入 `AR`，经行数存地址译码
4. 选取 `R2` 中的内容 120 作为要写入的数据
5. 将 120 放到 DBUS 上
6. 写入



### JMP

主要是在第二个 `CPU` 周期中将地址送入 `PC`

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220510154749.png)

![](C:%5CUsers%5Cgcl%5CDesktop%5C20220510154724.png)



1. 将地址码发送到 `DBUS` 上
2. 将地址码打入程序计数器中



上述的指令执行流程还可以简化为使用流程图来表示

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220510155054.png)



### 例题

根据下面的 CPU 结构图画出流程图

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220510155346.png)

画出 `ADD	R2, R0`

解：

1. 首先从取指令开始，程序计数器发出指令位置信息，结果 G ARi 打入 M 中
2. 从 M 中取出指令，又通过 G 送到 IR 中
3. 接着完成译码执行的操作

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220510155854.png)



## 时序产生器和控制装置

### 时序信号的机制和作用

> 二进制码表示的指令和数据都放在内存中，CPU 可以通过时间和目的地来区分这两者
>
> 具体来说，取指令事件发生在第一个 `CPU` 周期中，取数据事件发生在后面几个 CPU 周期中
>
> 从空间上来说，取出的指令会送往 `IR` 寄存器中，取出的数据会送到运算器

总之，计算机需要时间标志来指示其工作，而且应该采用多级时序体制，事件标志是由时序信号体现的

组成计算机的硬件特征决定了时序信号的基本的体制：电位 - 脉冲位

使用脉冲来控制，使用电位来表示数据

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220510192230.png)



#### 硬布线控制器的三级时序体制

- 主状态周期：一个触发器的状态持续时间，包含若干节拍电位
- 节拍电位：一个节拍电位表示一个 CPU 周期的时间
- 节拍脉冲：若干个节拍脉冲组成节拍电位

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220510200901.png)



#### 微程序控制器的二级时序体制

只包含节拍脉冲和节拍电位

- 节拍电位：将一个机器周期分为若干个相等的时间段，每个时间段对应一个电位信号，称为节拍电位信号

    节拍的宽度：取决于 CPU 完成一次基本操作的时间

- 工作脉冲：

    1. 在节拍中实行有些操作需要 同步定时 脉冲
    2. 节拍内可设置一个或几个工作脉冲，作为各种同步脉冲的来源
    3. 工作脉冲占节拍电位宽度的 `1 / n`，处于节拍的末尾

    ![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220510203633.png)

下面是 CPU 周期，节拍电位、节拍脉冲的时序关系

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220510203813.png)





### 时序信号的产生器

组成：

1. 时钟源
2. 环形脉冲发生器
3. 节拍脉冲和读写时序
4. 启停控制逻辑

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220510204335.png)



<img src="https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220510211722.png" style="zoom:67%;" />



我们比较关心的是启停控制逻辑

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220510204903.png)

通过控制 `Q` 可以封锁原始信号或者是将原始信号变为 CPU 所需的时序信号

可以配合启动/停机信号在 `T4 0` 后沿将 1 / 0 打入 `Cr` 实现启停逻辑





### 控制方式

#### 同步控制

在任何情况下，既定的指令在执行时所需的 `CPU` 的周期数和时钟周期数不变

可以实现以下方案来实现同步控制：(cv)

1. 采用完全统一的机器周期执行各种不同的指令

    ![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220510210127.png)

2. 采用不定长的机器周期

    对于耗时操作使用更长的机器周期

    ![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220510210633.png)

3. 中央控制与局部控制结合

    大部分指令安排在固定的机器周期中完成

    少数复杂的指令采用另外的时序经行定时

    假大空套



#### 异步控制

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220510210814.png)

要多少时间就占用多少时间



#### 联合控制

两种相结合

1. 大部分固定机器周期，对时间难以确定的操作实行 `请求 - 响应`
2. 机器周期的节拍脉冲数固定，但是指令周期的机器周期数不固定



### OC 组成总结

- 指令部件
    1. 程序计数器
    2. 指令译码器
    3. 指令寄存器
- 时序部件
    1. 脉冲源 以及 启停逻辑
    2. 时序信号 形成部件
    3. 控制方式

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220510211842.png)





## 微程序控制器

微程序实际上来说是指令的微程序，一条机器指令对应着一段程序

微程序由若干条微指令组成，这些被放在控制存储器中，当机器运行时，一条条地被读出(微命令)使对应部件做规定的动作(微操作)	



![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220511085432.png)



### 微程序控制原理

微指令可能是控制某个端口的一组二进制位组成的数字序列

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220511085555.png)

例如，在上图中，我们可以使用带有每个端口的控制信息的二进制序列来表示状态

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220511085718.png)

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220511085948.png)

### 微程序控制器组成原理

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220511152511.png)

控制存储器用来存放全部指令系统中的微程序，是 ROM

微地址是控存单元的地址，一个单元代表某一个节拍一组微操作控制信号的信息

计算机执行机器指令的过程：

1. 产生一段 `取机器指令` 的微程序，将要实现读取机器指令并且送往指令寄存器的功能
2. 机器指令操作码通过微地址形成部件，经过地址转移逻辑，产生微程序入口地址，并送入微地址寄存器
3. 控制存储器根据微指令的微地址，逐条取出对应的微指令，每条微指令提供一个微命令序列，执行有关的操作(装到微命令寄存器中，产生微命令信号控制执行)，每条指令都能自动产生下一条微指令的地址
4. 执行完一条机器指令对应的一段微程序之后，返回取微程序的入口，接着取机器指令后执行



综上所述，微程序控制器的基本思想就是使用软件的方式来控制硬件

不断从控存中取出微指令，产生执行指令需要的操作控制信号



下面我们来看 CPU 周期和微指令周期之间的关系：

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220511153042.png)

在前 600ns 中完成运算，`T4` 上升沿将运算结果打入某个寄存器，然后利用 `T4` 间隔读取下一条微指令，在下一个 `	T1` 上升沿将指令打入 `uIR` 

这条指令的生命周期就是一个 CPU 周期



### 微程序的控制技术

#### 微命令编码

微指令的一般格式是：

```shell
[操作控制值字段 | 顺序控制字段]
       ^
       |
1. 直接表示法
2. 编码表示法
3. 混合表示法
```

直接表示法控制字段中的每一个微命令都用一位的信息表示，使用 `1/0` 表示选或不选，这样可能会导致微指令较长

编码表示法将一组互斥的微命令信号组成一个小组，通过译码器为每一个小组信号经行译码，然后输出，减少了指令字的长度，然而带来译码的时间的损耗

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220512090945.png)

将相斥的命令划为同一组，将相容的命令发布在不同组中，可以提高信息的利用率，又可以实行并行操作，加快执行的速度

还可以送入常数字段作为循环的次数

混合表示法结合了上述两种



#### 微地址的形成方法

后继微地址的形成方法：

1. 计数器方式

    后继微地址由现在的微地址加上一个增量来表示

    非顺序执行的话。必须通过转移的方式，转去执行下一条

    <img src="https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220512093403.png" style="zoom:50%;" />

2. 多路转移方式 - 经行逻辑运算后的结果

    - 不产生分支的时候，后继微地址直接由微指令的控制顺序字段给出

    - 出现分支时，有若干"候选"微地址：按照顺序控制字段中的“判别测试”标志和“状态条件”信息来选择一个

        ![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220512093757.png)





#### 微指令格式

1. 水平微指令格式

    一次能够定义并执行多个并行操作微命令的微指令格式

    ![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220512094521.png)

    

2. 垂直微指令格式

    有点像机器指令，设置操作码字段，编译微操作吗=码，由它规定微指令的功能

    用它实现一条机器指令的微程序的长度要比前者长很多，但是其微指令结构的长度较短



#### 动态微程序设计

静态微程序设计

计算机上的机器指令只有一组微程序，不变

动态程序设计

采用 `E2PROM` 作为控制存储器，可以通过改变微指令和微程序来改变机器的指令系统，因而可以在同一台机器上实现不同的指令系统





## 硬布线控制器

> 把控制部件看作是专门产生固定时序控制信号的逻辑电路
>
> 以使用最少的原件和取得最高操作速度为设计目标

这种逻辑电路是一种由门控电路和触发器构成的复杂的树形网络，故称为硬布线控制器

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220512102701.png)

设计流程：

1. 绘出流程图
2. 列出微操作时间表
3. 微操作的逻辑实现 
4. 电路实现

这里面的微指令流程与 CPU 结构中的指令流程如出一辙，了解就好

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220512102949.png)

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220512103332.png)

可以看到流水线的设计思路



### 特点

- 速度快
- 采用三级时序
- 电路设计复杂，添加功能不易



### 两种控制方式的比较

- 相同：
    1. 能够根据指令操作码和时序信号，产生各种控制信号，正确建立各种数据通路，完成取指令和执行的控制
- 不同：
    1. 速度(硬布线控制)
    2. 规整，灵活，可维护(微程序控制)



## 流水 CPU

### 并行处理技术

首先我们来思考，怎么样来提高计算机的处理速度

- 提高运算器的速度 —— 高速芯片、改进算法、先行进位
- 提高访存速度 —— 存储架构、cache、芯片
- 提高 广义外存 的速度(ISA接口、网络) —— DMA、多通道
- 提高真机的处理性能 —— 开发新的系统结构、并行性



并行 —— 在同一时刻多个事件发生

1. 时间并行 多个处理过程在时间上错开，轮流重叠的使用同一套硬件上的不同部分，加快硬件周转
2. 空间并行 资源重复
3. 时空并行

并发 —— 在一段时间段中有多个事件发生



多体交叉存储器(低位)，可以使存储器的存取时间和流水线的其他阶段速度相匹配

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220516202039.png)



在运算器中，常常采用并行运算部件和部件流水线结合的工作方式

1. 将执行部件划为 定点执行运算部件 和 浮点执行部件 两个可以并行执行的部分
2. 浮点运算过程可以采用流水线的形式，有 浮点加法部件(指数部分) 和 乘除部件



我们可以将 CPU 取指令执行的过程分为 `IF ID EX WB` 四个部分，根据流水线可以画出以下的时序图

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220516202640.png)



[超标量](https://zh.wikipedia.org/zh-sg/%E8%B6%85%E7%B4%94%E9%87%8F) 的 CPU 架构支持指令集并发，同一时刻能够 dispatch 多条指令在不同的执行单元中执行，效率更高



按照流水线中处理的内容不同，我们可以作以下的分类

1. 指令流水线 执行处理步骤的并行
2. 算数流水线 运算操作步骤的并行
3. 处理机流水线 再宏观一点的步骤的并行



### 流水线中的主要问题

> 关于这个话题，我已经在 [浮点运算流水线化](https://github.com/GuanChenLu/cs_review_outline/blob/main/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/CC%E5%B0%8F%E8%AE%A1-0x06_%E6%B5%AE%E7%82%B9%E8%BF%90%E7%AE%97%E8%A7%84%E5%88%99.md) 的章节中阐述过了，下面只做简单的描述

#### 获取资源冲突

典型的场景就是 `访存` 和 `IF` 同时发生，然而存储器只有一个端口

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220516204841.png)

解决方式：

1. 延迟某个指令
2. 指令和数据分别放在两个存储器中(哈弗结构计算机)
3. 多端口存储器模型



#### 数据冒险

后一个指令依赖于前一个指令操纵的数据

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220516205130.png)

解决方式：

1. NOP

2. 直接向后一条指令输送运算结果

    设置若干运算结果的缓冲的寄存器暂存运算结果，减少访存



#### 控制转移冒险

流水线中，指令使并行执行的，可能判断相关的指令 Z 没有 `EX` ，后面的A、B指令就完成了 `IF ID`等待被执行，如果判断指令指示到要跳转到其他的对方，那么后面的指令就无效了

遇到这种情况，处理器需要将 A B 指令对应的流水线排空，然后跳转到 Z 指令得到的新的目标地址上进入新的流水线，产生了 `转移开销`

在循环中写条件判断语句需要小心



流水线结构当然不能因为判断而停止，只会接着执行以下的语句，这个 `以下的语句` 可以推测，可以根据前几次的跳转

解决方式：

1. 延迟转移法  先执行再转移
2. 转移预测法  



## pentium CPU



## RISC CPU

### 特点

1. 指令有序简单
2. CPU 配备大量的通用寄存器
3. 强调对流水指令的优化
4. 编译程序较复杂

![](https://pic22go.oss-cn-beijing.aliyuncs.com/md/20220516210746.png)

 

<br/>

<br/>

---



完

:slightly_smiling_face:



